# Development Guide

## Introduction

The rk8s repository is structured as a monorepo to unify the development of related tools and services under a single codebase. The top-level layout is organized as follows:

```
rk8s
├── BUCK
├── docs                # Documentation
│   ├── development.md	# Guide for development (this file) 
│   └── ...
├── project             # Cargo workspace containing core components
│   ├── Cargo.lock      # Locks exact dependency versions for reproducible builds
│   ├── Cargo.toml      # Workspace manifest
│   ├── rkb             # Image builder and registry management tool
│   ├── rkl             # Container runtime interface
│   ├── rks             # Control plane server
│   ├── test            # Integration tests
│   └── ...
├── README.md           # Project overview and quick start
├── third-party         # External dependencies and vendored sources
│   ├── README.md       # Instructions for managing third-party dependencies
│   └── rust            # Rust dependencies (generated by Buckal)
└── ...
```

This structure supports scalable, unified builds via [Buck2](https://buck2.build/) while maintaining clear separation between application logic, dependencies, and documentation. 

The integration of Buckal (also known as `cargo-buckal`), a plugin that enables seamless migration from Cargo to Buck2, ensures that changes to `Cargo.toml` are automatically reflected in the generated BUCK files. This allows developers to use Buck2 with a familiar, Cargo-like workflow — without manual build file maintenance.

## Environment Setup

Follow these steps to set up your development environment:

- Install Rust:

  ```bash
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
  ```

  After installation, ensure that the `~/.cargo/bin` directory is added to your `PATH` environment variable.

- Install Buck2:

  ```bash
  export ARCH="$(uname -m)"
  curl "https://github.com/facebook/buck2/releases/download/latest/buck2-${ARCH}-unknown-linux-gnu.zst" --output /tmp/buck2-${ARCH}-unknown-linux-gnu.zst --location
  zstd -d /tmp/buck2-${ARCH}-unknown-linux-gnu.zst -o $HOME/.cargo/bin/buck2
  chmod +x $HOME/.cargo/bin/buck2
  ```

- Install Buckal:

  ```bash
  cargo install --git https://github.com/buck2hub/cargo-buckal.git
  ```

  NOTE: Buckal requires Buck2 and Python 3. Please ensure both are installed on your system before proceeding.

- Install System Tools and Dependencies (on Debian-based Linux distributions):

  ```bash
  sudo apt-get install build-essential clang lld pkg-config protobuf-compiler
  sudo apt-get install seccomp libseccomp-dev
  ```

## Building the Monorepo

Clone the repository:

```bash
git clone https://github.com/r2cn-dev/rk8s.git
cd rk8s
```

Build all targets in the repository:

```bash
buck2 build //project/...
```

Alternatively, list all available build targets and build only the ones you need:

```bash
buck2 targets //...
```

## Per-Project Development

Each project in the monorepo is developed as a crate within the `project/` workspace. The following steps outline common development tasks using Buckal to manage dependencies and build configurations.

1. Add a New Project

   To create a new crate inside the `project/` directory, run:

   ```bash
   cargo buckal new <example>
   ```

   Then, manually add it to the `workspace.members` array in `project/Cargo.toml`.

2. Add a Dependency

   Inside your project directory (e.g., `project/rkb`), use the familiar Cargo-like syntax to add a dependency:

   ```bash
   cargo buckal add <DEP>[@<VERSION>] [--features <FEATURES>]
   ```

3. Build the Project

   To build your crate with Buck2, run:

   ```
   cargo buckal build
   ```

4. (Optional) Migrate After Manual Edits

   If you edit `Cargo.toml` directly (e.g., adding dependencies or updating package version by hand), synchronize the changes to BUCK files by running:

   ```
   cargo buckal migrate
   ```

## Dependency Management

For detailed information on managing third-party dependencies, refer to the `third-party/README.md` file.

## Code Style & Linting

### Dependency Import Order

This section outlines the recommended dependency import order. Imports should be grouped and separated by blank lines in the following order: 

- `std` and `core`
- External crates
- Current crate, paths prefixed by `crate`

Example:

```rust
use std::fs::File;

use itertools::Itertools;
use syntax::ast;

use crate::utils::insert_use;
```

### rustfmt

The rk8s project uses `rustfmt` to enforce a consistent code style. Before submitting your changes, please format your code by running the following command:

```bash
cd project
cargo fmt --package <PACKAGE_NAME>
```

You can find the `<PACKAGE_NAME>` in the `[workspace]` section of the `project/Cargo.toml` file. Note that you only need to run the above command for the packages you have modified.

### clippy

Additionally, you must run Clippy to check for potential issues in the code:

```
cargo clippy --workspace -- -D warnings
```

Please ensure that you run the above commands before submitting your code and resolve any warnings or errors that are reported.

## Contributing

For more information on how to contribute to the project, including creating pull requests, code reviews, and testing requirements, please refer to the [Contributing Guide](./contributing.md).
